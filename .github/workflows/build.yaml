name: Build and Push Images
on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
permissions:
  contents: read
  packages: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Calculate Version and Revision
        id: vars
        run: |
          # Calculate Short SHA
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          
          # Calculate App Version
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "APP_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
            echo "IS_RELEASE=true" >> $GITHUB_ENV
          else
            echo "APP_VERSION=main" >> $GITHUB_ENV
            echo "IS_RELEASE=false" >> $GITHUB_ENV
          fi

      # Backend image
      - name: Build & push novus-backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.IS_RELEASE == 'true' && format('ghcr.io/tolgaozgun/novus-backend:{0}', env.APP_VERSION) || '' }}
            ${{ env.IS_RELEASE == 'true' && format('ghcr.io/tolgaozgun/novus-backend:{0}-{1}', env.APP_VERSION, env.SHORT_SHA) || '' }}
            ${{ env.IS_RELEASE == 'false' && format('ghcr.io/tolgaozgun/novus-backend:main-{0}', env.SHORT_SHA) || '' }}
          build-args: |
            APP_VERSION=${{ env.APP_VERSION }}
            GIT_REVISION=${{ env.SHORT_SHA }}

      - name: Update Kubernetes Manifests
        uses: actions/checkout@v4
        with:
          repository: tolgaozgun/k8s-manifests
          token: ${{ secrets.PAT_TOKEN }}
          path: k8s-manifests
      - name: Update Image Tags
        run: |
          cd k8s-manifests
          
          # Determine the tag to use in k8s
          if [[ "${{ env.IS_RELEASE }}" == "true" ]]; then
            NEW_TAG="${{ env.APP_VERSION }}-${{ env.SHORT_SHA }}"
          else
            NEW_TAG="main-${{ env.SHORT_SHA }}"
          fi
          
          # Update Backend Image
          # Updating apps/novus/novus.yaml based on project name 'novus'
          # If the file path is different, this will need adjustment
          sed -i "s|image: ghcr.io/tolgaozgun/novus-backend:.*|image: ghcr.io/tolgaozgun/novus-backend:${NEW_TAG}|" apps/novus/novus.yaml
          
          # Check for changes
          if [[ -z $(git status -s) ]]; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "CI Bot"
          git config user.email "ci@novus.app"
          git add apps/novus/novus.yaml
          git commit -m "chore(novus): update images to ${{ github.sha }}"
          git push
